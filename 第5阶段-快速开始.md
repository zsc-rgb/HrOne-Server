# 🚀 第5阶段快速开始指南

> 系统基础模块 - 用户、角色、菜单、部门管理

---

## ✅ 已完成配置

### 5.1 数据库表设计 ✅

**已创建表：**
- ✅ sys_dept - 部门表（树形结构）
- ✅ sys_role - 角色表
- ✅ sys_menu - 菜单权限表（树形结构）
- ✅ sys_user_role - 用户角色关联表
- ✅ sys_role_menu - 角色菜单关联表
- ✅ sys_role_dept - 角色部门关联表（数据权限）
- ✅ sys_user - 更新（添加dept_id字段）

**SQL脚本：**
- `sql/hrone_system.sql` - 系统基础表结构和初始数据

---

### 5.2 实体类 ✅

**已创建：**
- ✅ SysDept - 部门实体（176行）
- ✅ SysRole - 角色实体（170行）
- ✅ SysMenu - 菜单实体（195行）
- ✅ SysUser - 更新（添加deptId字段）

**特点：**
- 继承BaseEntity获得通用字段
- 使用MyBatis-Plus注解
- 支持树形结构（children字段）
- 逻辑删除支持

---

### 5.3 Mapper接口 ✅

**已创建：**
- ✅ SysDeptMapper - 部门Mapper
- ✅ SysRoleMapper - 角色Mapper
- ✅ SysMenuMapper - 菜单Mapper

**特点：**
- 继承BaseMapper自动获得CRUD方法
- @Mapper注解自动扫描

---

### 5.4 Service层 ✅

**已创建：**
- ✅ ISysDeptService + SysDeptServiceImpl（200+行）
- ✅ ISysRoleService + SysRoleServiceImpl（180+行）
- ✅ ISysMenuService + SysMenuServiceImpl（150+行）

**核心功能：**
- 列表查询、树结构构建
- 唯一性校验
- 业务规则验证
- 关联关系处理

---

### 5.5 Controller层 ✅

**已创建：**
- ✅ SysDeptController - 部门管理（90行）
- ✅ SysRoleController - 角色管理（110行）
- ✅ SysMenuController - 菜单管理（105行）

**接口数量：** 20个RESTful API

---

### 5.6 树形结构工具类 ✅

**已创建：**
- ✅ TreeUtils - 通用树形结构工具（120行）

**功能：**
- 泛型支持，适用于任何树形数据
- 递归构建树结构
- 查找所有子节点ID

---

## ⚠️ 重要：启动前准备

### 步骤1：确认MySQL数据库已准备

**检查数据库：**
```bash
mysql -u root -p
USE hrone_db;
SHOW TABLES;
```

**应该看到第3阶段创建的表：**
- sys_user

### 步骤2：执行第5阶段SQL脚本

```bash
cd d:\HroneWorking\hrone-Server
mysql -u root -p < sql/hrone_system.sql
```

**或者使用Navicat等工具执行 `sql/hrone_system.sql`**

### 步骤3：验证表是否创建成功

```sql
mysql -u root -p
USE hrone_db;

-- 查看所有表
SHOW TABLES;

-- 应该看到：
-- sys_user（已有）
-- sys_dept（新增）
-- sys_role（新增）
-- sys_menu（新增）
-- sys_user_role（新增）
-- sys_role_menu（新增）
-- sys_role_dept（新增）

-- 查看部门数据
SELECT * FROM sys_dept;
-- 应该有6条数据

-- 查看角色数据
SELECT * FROM sys_role;
-- 应该有2条数据

-- 查看菜单数据
SELECT * FROM sys_menu;
-- 应该有14条数据
```

---

## 🧪 测试接口

### 部门管理接口（6个）

| 序号 | 接口 | 方法 | 说明 |
|-----|------|------|------|
| 1 | `/system/dept/list` | GET | 查询部门列表 |
| 2 | `/system/dept/tree` | GET | 查询部门树结构 |
| 3 | `/system/dept/{deptId}` | GET | 查询部门详情 |
| 4 | `/system/dept` | POST | 新增部门 |
| 5 | `/system/dept` | PUT | 修改部门 |
| 6 | `/system/dept/{deptId}` | DELETE | 删除部门 |

### 角色管理接口（7个）

| 序号 | 接口 | 方法 | 说明 |
|-----|------|------|------|
| 1 | `/system/role/list` | GET | 查询角色列表 |
| 2 | `/system/role/page` | GET | 分页查询角色 |
| 3 | `/system/role/{roleId}` | GET | 查询角色详情 |
| 4 | `/system/role` | POST | 新增角色 |
| 5 | `/system/role` | PUT | 修改角色 |
| 6 | `/system/role/{roleId}` | DELETE | 删除角色 |
| 7 | `/system/role/batch` | DELETE | 批量删除角色 |

### 菜单管理接口（7个）

| 序号 | 接口 | 方法 | 说明 |
|-----|------|------|------|
| 1 | `/system/menu/list` | GET | 查询菜单列表 |
| 2 | `/system/menu/tree` | GET | 查询菜单树结构 |
| 3 | `/system/menu/{menuId}` | GET | 查询菜单详情 |
| 4 | `/system/menu` | POST | 新增菜单 |
| 5 | `/system/menu` | PUT | 修改菜单 |
| 6 | `/system/menu/{menuId}` | DELETE | 删除菜单 |
| 7 | `/system/menu/user/{userId}` | GET | 查询用户菜单 |

**总计：20个新接口**

---

## 🔍 测试示例

### 1. 查询部门树结构

```
GET http://localhost:8080/system/dept/tree

响应：
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "deptId": 100,
      "deptName": "HROne科技",
      "parentId": 0,
      "orderNum": 0,
      "leader": "管理员",
      "children": [
        {
          "deptId": 101,
          "deptName": "深圳总公司",
          "parentId": 100,
          "children": [
            {
              "deptId": 103,
              "deptName": "研发部门",
              "parentId": 101
            },
            ...
          ]
        },
        {
          "deptId": 102,
          "deptName": "北京分公司",
          "parentId": 100
        }
      ]
    }
  ]
}
```

### 2. 查询角色列表

```
GET http://localhost:8080/system/role/list

响应：
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "roleId": 1,
      "roleName": "超级管理员",
      "roleKey": "admin",
      "roleSort": 1,
      "status": "0"
    },
    {
      "roleId": 2,
      "roleName": "普通角色",
      "roleKey": "common",
      "roleSort": 2,
      "status": "0"
    }
  ]
}
```

### 3. 查询菜单树结构

```
GET http://localhost:8080/system/menu/tree

响应：
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "menuId": 1,
      "menuName": "系统管理",
      "parentId": 0,
      "menuType": "M",
      "children": [
        {
          "menuId": 100,
          "menuName": "用户管理",
          "parentId": 1,
          "menuType": "C",
          "path": "user",
          "perms": "system:user:list",
          "children": [
            {
              "menuId": 1000,
              "menuName": "用户查询",
              "menuType": "F",
              "perms": "system:user:query"
            },
            ...
          ]
        },
        ...
      ]
    }
  ]
}
```

### 4. 新增部门

```
POST http://localhost:8080/system/dept
Content-Type: application/json

{
  "parentId": 101,
  "deptName": "人事部门",
  "orderNum": 4,
  "leader": "HR主管",
  "phone": "13800138000",
  "email": "hr@hrone.com",
  "status": "0"
}

响应：
{
  "code": 200,
  "msg": "操作成功"
}
```

---

## 🔍 核心知识点

### 1. 树形结构的实现

**数据库设计：**
```sql
parent_id    -- 父节点ID（0表示根节点）
ancestors    -- 祖级列表（如：0,100,101）
order_num    -- 显示顺序
```

**递归构建树：**
```java
// 使用TreeUtils工具类
List<SysDept> tree = TreeUtils.buildTree(
    depts,                  // 扁平化列表
    SysDept::getDeptId,     // 获取ID
    SysDept::getParentId,   // 获取父ID
    SysDept::getChildren,   // 获取children
    SysDept::setChildren,   // 设置children
    0L                      // 根节点ID
);
```

---

### 2. RBAC权限模型基础

**五表设计：**
```
用户表（sys_user）
  ↓ sys_user_role
角色表（sys_role）
  ↓ sys_role_menu
菜单表（sys_menu）
```

**数据权限：**
```
角色表（sys_role）
  ↓ sys_role_dept
部门表（sys_dept）
```

---

### 3. 祖级列表（Ancestors）

**作用：** 快速查找所有父节点和子节点

**示例：**
```
HROne科技（100）     ancestors = "0"
  ├─深圳总公司（101）  ancestors = "0,100"
  │   └─研发部门（103） ancestors = "0,100,101"
  └─北京分公司（102）  ancestors = "0,100"
```

**优点：**
- 快速查询所有父节点
- 快速查询所有子节点
- 避免递归查询数据库

---

### 4. 菜单类型

**三种类型：**
- **M（目录）**：一级菜单，只用于分组
- **C（菜单）**：可点击的菜单页面
- **F（按钮）**：页面内的操作按钮

**权限标识（perms）：**
```
system:user:list    -- 用户列表
system:user:query   -- 用户查询
system:user:add     -- 用户新增
system:user:edit    -- 用户编辑
system:user:remove  -- 用户删除
```

---

## ⚡ 启动项目

### 前提条件

1. ✅ MySQL已安装并启动
2. ✅ 数据库hrone_db已创建
3. ✅ 已执行 hrone_system.sql
4. ✅ Redis已启动（第4阶段）

### 启动命令

```bash
# 方法1：使用脚本
双击：d:\HroneWorking\启动后端.bat

# 方法2：命令行
cd d:\HroneWorking\hrone-Server
mvn spring-boot:run -pl hrone-admin
```

**启动成功标志：**
```
HikariPool-1 - Start completed.
Lettuce PoolingConnectionProvider.getConnection
========================================
   HROne 后端系统启动成功！
========================================
```

---

## 🆘 常见问题

### Q1: 表已存在错误？

**错误：** `Table 'sys_dept' already exists`

**解决：**
```sql
-- 删除已有的表（谨慎！）
DROP TABLE IF EXISTS sys_dept;
DROP TABLE IF EXISTS sys_role;
DROP TABLE IF EXISTS sys_menu;

-- 重新执行脚本
SOURCE sql/hrone_system.sql;
```

---

### Q2: ancestors字段为空？

**问题：** 新增部门后ancestors为空

**原因：** parentId对应的父部门不存在

**解决：** 确保父部门ID正确，或者设置parentId=0

---

### Q3: 树结构查询返回空？

**问题：** 调用/tree接口返回空数组

**原因：** 
1. 数据库没有数据
2. parentId关系不正确

**解决：**
```sql
-- 检查数据
SELECT * FROM sys_dept;

-- 检查parent_id
SELECT dept_id, dept_name, parent_id FROM sys_dept;
```

---

## ✅ 完成检查清单

### 数据库准备 ✅
- [ ] MySQL已启动
- [ ] hrone_db数据库存在
- [ ] 已执行 hrone_system.sql
- [ ] sys_dept表有6条数据
- [ ] sys_role表有2条数据
- [ ] sys_menu表有14条数据

### 代码实现 ✅
- [x] 实体类已创建（3个）
- [x] Mapper已创建（3个）
- [x] Service已创建（3个）
- [x] Controller已创建（3个）
- [x] TreeUtils工具类已创建
- [x] 项目编译成功

---

## 🎯 测试流程

### 1. 启动项目

### 2. 测试部门接口

```
# 查询部门列表
GET http://localhost:8080/system/dept/list

# 查询部门树
GET http://localhost:8080/system/dept/tree

# 新增部门
POST http://localhost:8080/system/dept
{
  "parentId": 101,
  "deptName": "人事部",
  "orderNum": 4
}
```

### 3. 测试角色接口

```
# 查询角色列表
GET http://localhost:8080/system/role/list

# 新增角色
POST http://localhost:8080/system/role
{
  "roleName": "测试角色",
  "roleKey": "test",
  "roleSort": 3,
  "status": "0"
}
```

### 4. 测试菜单接口

```
# 查询菜单树
GET http://localhost:8080/system/menu/tree

# 查询用户菜单
GET http://localhost:8080/system/menu/user/1
```

---

**🎉 第5阶段代码已就绪！等待MySQL数据库准备后即可测试！** 🚀

