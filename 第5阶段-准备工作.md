# 📝 第5阶段准备工作

> 系统基础模块 - 需要在第3阶段MySQL的基础上扩展

---

## ✅ 第5阶段概述

### 学习目标
- 实现系统基础模块（用户、角色、菜单、部门）
- 掌握RBAC权限模型的基础
- 理解树形结构的实现
- 掌握关联表的设计

### 需要准备
1. ✅ 第3阶段已完成（MySQL已配置）
2. ✅ 第4阶段已完成（Redis已配置）
3. ✅ MySQL数据库正常运行
4. ✅ hrone_db数据库已存在

---

## 📦 步骤1：确认MySQL环境

### 检查MySQL是否运行

```bash
# Windows
net start | findstr MySQL

# 或者
mysql --version
```

**如果MySQL未安装：** 请先完成第3阶段的准备工作

---

## 📝 步骤2：执行系统表SQL脚本

### 方法1：使用命令行（推荐）

```bash
cd d:\HroneWorking\hrone-Server
mysql -u root -p < sql/hrone_system.sql
```

输入密码后等待执行完成。

### 方法2：使用Navicat等工具

1. 连接MySQL（localhost:3306）
2. 选择 hrone_db 数据库
3. 打开 `sql/hrone_system.sql` 文件
4. 点击"运行"按钮
5. 查看执行结果

---

## ✅ 步骤3：验证表是否创建成功

### 查看所有表

```sql
USE hrone_db;
SHOW TABLES;
```

**应该看到以下表：**
```
sys_user         -- 用户表（第3阶段已有）
sys_dept         -- 部门表（新增）
sys_role         -- 角色表（新增）
sys_menu         -- 菜单表（新增）
sys_user_role    -- 用户角色关联表（新增）
sys_role_menu    -- 角色菜单关联表（新增）
sys_role_dept    -- 角色部门关联表（新增）
```

### 验证测试数据

```sql
-- 查看部门数据（应该有6条）
SELECT dept_id, dept_name, parent_id FROM sys_dept;

-- 查看角色数据（应该有2条）
SELECT role_id, role_name, role_key FROM sys_role;

-- 查看菜单数据（应该有14条）
SELECT menu_id, menu_name, parent_id, menu_type FROM sys_menu;

-- 查看用户角色关联（应该有1条：admin-超级管理员）
SELECT * FROM sys_user_role;
```

**预期结果：**
| 表名 | 数据量 | 说明 |
|------|--------|------|
| sys_dept | 6条 | 1个根部门 + 5个子部门 |
| sys_role | 2条 | 超级管理员 + 普通角色 |
| sys_menu | 14条 | 2个目录 + 4个菜单 + 8个按钮 |
| sys_user_role | 1条 | admin用户关联超级管理员 |
| sys_role_menu | 14条 | 超级管理员拥有所有菜单 |

---

## 🔍 步骤4：理解表结构设计

### 部门表（sys_dept）- 树形结构

**关键字段：**
```sql
dept_id       -- 部门ID（主键）
parent_id     -- 父部门ID（0表示根节点）
ancestors     -- 祖级列表（如：0,100,101）
dept_name     -- 部门名称
order_num     -- 显示顺序
leader        -- 负责人
status        -- 状态（0正常 1停用）
del_flag      -- 删除标志（逻辑删除）
```

**树形结构示例：**
```
HROne科技（100）
├─深圳总公司（101）
│  ├─研发部门（103）
│  ├─市场部门（104）
│  └─财务部门（105）
└─北京分公司（102）
```

---

### 角色表（sys_role）

**关键字段：**
```sql
role_id       -- 角色ID（主键）
role_name     -- 角色名称（如：超级管理员）
role_key      -- 角色权限字符串（如：admin）
role_sort     -- 显示顺序
data_scope    -- 数据范围（1全部 2自定义 3本部门 4本部门及以下 5仅本人）
status        -- 状态（0正常 1停用）
```

**数据权限级别：**
- 1 - 全部数据权限
- 2 - 自定义数据权限
- 3 - 本部门数据权限
- 4 - 本部门及以下数据权限
- 5 - 仅本人数据权限

---

### 菜单表（sys_menu）- 树形结构

**关键字段：**
```sql
menu_id       -- 菜单ID（主键）
menu_name     -- 菜单名称
parent_id     -- 父菜单ID（0表示根节点）
menu_type     -- 菜单类型（M目录 C菜单 F按钮）
path          -- 路由地址
component     -- 组件路径
perms         -- 权限标识（如：system:user:list）
icon          -- 菜单图标
order_num     -- 显示顺序
```

**三种菜单类型：**
- **M（目录）**：系统管理、系统监控等
- **C（菜单）**：用户管理、角色管理等
- **F（按钮）**：查询、新增、修改、删除等

---

### 关联表设计

**用户-角色关联（sys_user_role）：**
```sql
user_id, role_id    -- 联合主键
```
- 一个用户可以有多个角色
- 一个角色可以分配给多个用户

**角色-菜单关联（sys_role_menu）：**
```sql
role_id, menu_id    -- 联合主键
```
- 一个角色可以有多个菜单权限
- 一个菜单可以分配给多个角色

**角色-部门关联（sys_role_dept）：**
```sql
role_id, dept_id    -- 联合主键
```
- 用于数据权限控制
- 限制角色可以访问哪些部门的数据

---

## 📊 初始化数据说明

### 部门数据（6条）

| dept_id | dept_name | parent_id | ancestors |
|---------|-----------|-----------|-----------|
| 100 | HROne科技 | 0 | 0 |
| 101 | 深圳总公司 | 100 | 0,100 |
| 102 | 北京分公司 | 100 | 0,100 |
| 103 | 研发部门 | 101 | 0,100,101 |
| 104 | 市场部门 | 101 | 0,100,101 |
| 105 | 财务部门 | 101 | 0,100,101 |

### 角色数据（2条）

| role_id | role_name | role_key | data_scope |
|---------|-----------|----------|------------|
| 1 | 超级管理员 | admin | 1（全部） |
| 2 | 普通角色 | common | 2（自定义） |

### 菜单数据（14条）

**目录（2个）：**
- 系统管理（menu_id=1）
- 系统监控（menu_id=2）

**菜单（4个）：**
- 用户管理（menu_id=100）
- 角色管理（menu_id=101）
- 菜单管理（menu_id=102）
- 部门管理（menu_id=103）

**按钮（8个）：**
- 用户查询/新增/修改/删除（menu_id=1000-1003）
- 角色查询/新增/修改/删除（menu_id=1010-1013）

---

## 🧪 步骤5：测试数据库连接

### 编译项目

```bash
cd d:\HroneWorking\hrone-Server
mvn clean install -DskipTests
```

**预期：** BUILD SUCCESS ✅

### 启动项目

```bash
mvn spring-boot:run -pl hrone-admin
```

**启动成功标志：**
```
HikariPool-1 - Start completed.
```

---

## 🔍 常见问题

### Q1: sys_user表没有dept_id字段？

**错误：** `Unknown column 'dept_id' in 'field list'`

**解决：**
```sql
-- 手动添加字段
ALTER TABLE sys_user ADD COLUMN dept_id BIGINT(20) DEFAULT NULL COMMENT '部门ID' AFTER user_id;
```

---

### Q2: 外键约束错误？

**错误：** `Cannot add or update a child row: a foreign key constraint fails`

**说明：** 我们的设计没有使用外键约束，如果遇到此错误，检查：
1. parent_id是否存在对应的记录
2. 数据插入顺序是否正确

---

### Q3: 祖级列表如何理解？

**ancestors字段：**
- 存储从根节点到当前节点的所有父节点ID
- 使用逗号分隔
- 方便快速查询所有父节点或子节点

**示例：**
```
研发部门（103）的ancestors = "0,100,101"
表示：根节点(0) → HROne科技(100) → 深圳总公司(101) → 研发部门(103)
```

---

## ✅ 准备完成检查清单

- [ ] MySQL服务正在运行
- [ ] hrone_db数据库存在
- [ ] 已执行 hrone_system.sql
- [ ] sys_dept表存在且有6条数据
- [ ] sys_role表存在且有2条数据
- [ ] sys_menu表存在且有14条数据
- [ ] sys_user表有dept_id字段
- [ ] 项目可以编译通过

**全部完成？** 开始测试第5阶段功能！🚀

---

## 🎯 下一步

准备完成后：
1. 启动项目
2. 测试部门树结构查询
3. 测试角色管理
4. 测试菜单树结构
5. 理解RBAC权限模型

**查看：** `第5阶段-快速开始.md` 了解测试方法

---

**加油！** 💪

